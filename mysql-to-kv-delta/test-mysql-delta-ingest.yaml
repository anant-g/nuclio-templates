metadata:
  name: test-mysql-delta-ingest
  labels:
    nuclio.io/project-name: e336fb52-2d6f-49a9-9cff-fa93fb85f8ae
spec:
  description: "incremental loading of data from mySql into iguazio KV"
  disable: true
  handler: "main:handler"
  runtime: "python:3.6"
  env:
    - name: CONTAINER
      value: bigdata
    - name: TABLE
      value: fruit
    - name: IGZ_V3F
      value: "v3io-framesd:8081"
    - name: IGZ_PWD
      value: datal@ke!
    - name: SQL_HOST
      value: 10.80.1.142
    - name: SQL_PORT
      value: "3306"
    - name: SQL_USER
      value: root
    - name: SQL_PWD
      value: password
    - name: SQL_DB_NAME
      value: test
    - name: SQL_QUERY
      value: "select * from tbl_students"
    - name: DELTA_INTERVAL_SEC
      value: "20"
    - name: CREATED_DATETIME_COL
      value: created_date
    - name: MODIFIED_DATETIME_COL
      value: modified_date
  resources: {}
  imageHash: "1550221129598247755"
  minReplicas: 1
  maxReplicas: 1
  triggers:
    delta-cron:
      class: ""
      kind: cron
      attributes:
        interval: 20s
  version: 1
  alias: latest
  build:
    functionSourceCode: CgogICAgICAKCiMgQ29weXJpZ2h0IDIwMTcgVGhlIE51Y2xpbyBBdXRob3JzLgojCiMgTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIik7CiMgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLgojIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAojCiMgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCgppbXBvcnQgb3MKaW1wb3J0IHBhbmRhcyBhcyBwZAppbXBvcnQgdGltZQppbXBvcnQgZGF0ZXRpbWUKZnJvbSBzcWxhbGNoZW15IGltcG9ydCBjcmVhdGVfZW5naW5lCmZyb20gc3FsYWxjaGVteS5vcm0gaW1wb3J0IHNlc3Npb25tYWtlcgppbXBvcnQgdjNpb19mcmFtZXMgYXMgdjNmCgoKZGVmIGhhbmRsZXIoY29udGV4dCwgZXZlbnQpOgogICAgZGVsdGFfaW50ZXJ2YWxfc2VjID0gb3MuZ2V0ZW52KCdERUxUQV9JTlRFUlZBTF9TRUMnKQogICAgbW9kaWZpZWRfY29sID0gb3MuZ2V0ZW52KCdNT0RJRklFRF9EQVRFVElNRV9DT0wnKQogICAgY3JlYXRlZF9jb2wgPSBvcy5nZXRlbnYoJ0NSRUFURURfREFURVRJTUVfQ09MJykKICAgIGRhdGV0aW1lX3F1ZXJ5ID0gc3RyKGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpIC0gZGF0ZXRpbWUudGltZWRlbHRhKHNlY29uZHM9aW50KGRlbHRhX2ludGVydmFsX3NlYykpKQogICAgc3FsX3F1ZXJ5ID0gb3MuZ2V0ZW52KCdTUUxfUVVFUlknKQogICAgc3FsX3F1ZXJ5X2RpZmYgPSBzcWxfcXVlcnkgKyAiIHdoZXJlICgiK2NyZWF0ZWRfY29sKyI+PSciK3N0cihkYXRldGltZV9xdWVyeSkrIicgQU5EICIrbW9kaWZpZWRfY29sKyIgSVMgTlVMTCkgT1IgKCIrbW9kaWZpZWRfY29sKyI+PSciK3N0cihkYXRldGltZV9xdWVyeSkrIicpIgogICAgY29udGV4dC5sb2dnZXIuZGVidWcoc3FsX3F1ZXJ5X2RpZmYpCiAgICBkZiA9IHBkLnJlYWRfc3FsKHNxbF9xdWVyeV9kaWZmLCBjb250ZXh0LmRiY29ubi5jb25uZWN0aW9uKCkpCiAgICBjb250ZXh0LmxvZ2dlci5kZWJ1Zygibm8gb2YgZGVsdGEgcm93cyA6OiB7fSAiLmZvcm1hdChkZi5zaGFwZVswXSkpCiAgICBjb250ZXh0LmNsaWVudC53cml0ZShiYWNrZW5kPSdrdicsIHRhYmxlPW9zLmdldGVudignVEFCTEUnKSwgZGZzPWRmKQoKIApkZWYgaW5pdF9jb250ZXh0KGNvbnRleHQpOgogICAgIyBNWVNRTCB2YXJpYWJsZXMKICAgIGhvc3QgPSBvcy5nZXRlbnYoJ1NRTF9IT1NUJykKICAgIHBvcnQgPSBvcy5nZXRlbnYoJ1NRTF9QT1JUJykKICAgIHVzZXIgPSBvcy5nZXRlbnYoJ1NRTF9VU0VSJykKICAgIHBhc3N3b3JkID0gb3MuZ2V0ZW52KCdTUUxfUFdEJywgIiIpCiAgICBkYXRhYmFzZSA9IG9zLmdldGVudignU1FMX0RCX05BTUUnKQoKICAgICMgSW5pdCB2M2lvLWZyYW1lcyBjb25uZWN0aW9uIGFuZCBzZXQgaXQgYXMgYSBjb250ZXh0IGF0dHJpYnV0ZQogICAgY2xpZW50ID0gdjNmLkNsaWVudChhZGRyZXNzPW9zLmdldGVudignSUdaX1YzRicpLCBwYXNzd29yZD1vcy5nZXRlbnYoJ0lHWl9QV0QnKSwgY29udGFpbmVyPW9zLmdldGVudignQ09OVEFJTkVSJykpCiAgICBzZXRhdHRyKGNvbnRleHQsICdjbGllbnQnLCBjbGllbnQpCiAgICAKICAgIGNvbm5lY3Rpb25fc3RyaW5nID0gZiJteXNxbDovL3t1c2VyfTp7cGFzc3dvcmR9QHtob3N0fTp7cG9ydH0ve2RhdGFiYXNlfSIKICAgIGVuZ2luZSA9IGNyZWF0ZV9lbmdpbmUoY29ubmVjdGlvbl9zdHJpbmcsIGVuY29kaW5nID0gJ3V0ZjgnLCBjb252ZXJ0X3VuaWNvZGUgPSBUcnVlLAogICAgaXNvbGF0aW9uX2xldmVsPSdSRUFEX0NPTU1JVFRFRCcpCiAgICBzZXNzaW9uID0gc2Vzc2lvbm1ha2VyKCkKICAgIHNlc3Npb24uY29uZmlndXJlKGJpbmQ9ZW5naW5lKQogICAgZGJjb25uID0gc2Vzc2lvbigpCiAgICBzZXRhdHRyKGNvbnRleHQsICdkYmNvbm4nLCBkYmNvbm4pCg==
    baseImage: "python:3.6"
    commands:
      - 'pip install v3io-frames sqlalchemy mysqlclient pandas'
    runtimeAttributes:
      repositories: []
    codeEntryType: sourceCode
    timestamp: 1552970113
  loggerSinks:
    - level: debug
  platform: {}
  readinessTimeoutSeconds: 60
